manifest {
    mainScript = 'main.nf'
    name = 'pop_the_mod'
}

// default parameters
params {
    max_cores = Runtime.runtime.availableProcessors()    
    cores = Runtime.runtime.availableProcessors().intdiv(4)
    help = false
    memory = '12'
    profile = false

    // inputs
    fasta_ref = ''
    bam = ''
    samples = ''
    //output
    output = "results"
    runinfodir = "Pipeline-runinfo"

}
// runinfo
timeline {
  enabled = true
  overwrite = true  
  file = "${params.output}/${params.runinfodir}/execution_timeline.html"
}

report {
  enabled = true
  overwrite = true  
  file = "${params.output}/${params.runinfodir}/execution_report.html"
}


profiles {
    local {
        workDir = "work/nextflow-popthemod-$USER"
        includeConfig 'configs/local.config'
        executor {
            name = "local"
            cpus = params.max_cores
            memory = params.memory
        }

        process { errorStrategy = { task.exitStatus in [10,14,143,137,104,134,139] ? 'retry' : 'terminate' } }
    }

    docker {
        docker { 
            enabled = true
            fixOwnership = true
        }
        includeConfig 'configs/container.config'
    }

    ukj_cloud { 
            workDir = "/tmp/nextflow-methylation-analysis-$USER"
            docker { enabled = true }
            process { 
                            executor = 'google-batch' 
                            errorStrategy = { task.exitStatus in [10,14,143,137,104,134,139] ? 'retry' : 'terminate' }
                            maxRetries = 3
                            withLabel: noDocker           { container = 'nanozoo/template:3.8--d089809' }
                    }
            params {
                //databases = 'gs://databases-case-grp/phage_similarity_db/'
                //output = 'gs://case-tmp-dir/nextflow-phage_similarity/tmp-results'
                tmp_storage = 'gs://backup-case-mike/phage-methylation_tmp_storage/'
            }
            bucketDir = 'gs://case-tmp-dir/methylation-analysis/'
        
            google {  
                project = 'case-dev-302214'
                location = 'europe-west4'
            batch {  
                    spot = true
                    bootDiskSize = 15.GB // needs to be balanced with maxforks eg. 200 GB bootsize disk, maxfork 10 processes --> 2 TB of SSD usage - not good
                    maxSpotAttempts = 4
                }
            }
            includeConfig 'configs/container.config'
            includeConfig 'configs/nodes.config'
        }
}

